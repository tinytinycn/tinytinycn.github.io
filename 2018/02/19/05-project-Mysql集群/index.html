<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 05_project_Mysql集群 · hang 's blogs</title><meta name="description" content="05_project_Mysql集群 - hang"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/tinytinycn.github.io/favicon.png"><link rel="stylesheet" href="/tinytinycn.github.io/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://github.com/atom.xml" title="hang 's blogs"></head><body><div class="wrap"><header><a href="/tinytinycn.github.io/" class="logo-link"><img src="/tinytinycn.github.io/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/tinytinycn.github.io/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/tinytinycn.github.io/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/sunchongsheng" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pinggod" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/tinytinycn.github.io/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">05_project_Mysql集群</h1><div class="post-info">Feb 19, 2018</div><div class="post-content"><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li>数据库高可用</li>
<li>数据库备份方式</li>
<li>数据库高可用的实现</li>
<li>Amoeba 数据库代理</li>
<li>双机热备模式</li>
<li>Mycat 部署</li>
</ul>
<hr>
<ul>
<li>数据库高可用</li>
</ul>
<ol>
<li>问题: 单台数据库不能很好地应对高并发场景</li>
<li>解决: 数据库主从复制, 读写分离</li>
<li>分析: 数据库主从复制,读写分离, 可以有效减轻数据库高并发访问的压力. 主库负责写入操作, 从库负责查询操作.(如何保证数据同步?)</li>
<li>主从复制原理:<br>当主库发生更新操作时, 会将更新操作写入二进制日志文件中(Binarylog).从库的IO线程实时监控主库的二进制日志文件, 查看是否发生变化. 若变化, 则读取变化的日志文件, 写入中继日志文件中(Relaylog).从库的SQL线程监控中继日志文件, 将新增日志文件通过sql语句实现数据库的更新.</li>
</ol>
<ul>
<li>数库库备份方式</li>
</ul>
<ol>
<li>冷备份: 数据库在固定时间内, 将数据库文件实现转储保存. </li>
<li>热备份: 当主库做更新操作时, 从库会立即执行更新操作, 达到实时备份. (主从复制原理)</li>
</ol>
<ul>
<li>数据库高可用的实现<br>主从复制的实现:</li>
</ul>
<ol>
<li>为数据库创建ID标识</li>
<li>开启二进制日志文件</li>
<li>查询二进制日志状态(文件名/文件路径)</li>
<li>从库配置(指定主库位置:ip/port=3306/username/password/二进制文件名和路径O)</li>
<li>开启主从模式<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">// 配置id/日志/查看状态 如下操作:</span><br><span class="line"></span><br><span class="line">1. 修改mysql配置 vim /etc/my.cnf</span><br><span class="line">2. 配置id 和文件名</span><br><span class="line">server-id=1</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line">3. 重启mysql: service mysql restart</span><br><span class="line">4. 检查日志文件是否开启: cd /var/lib/mysql </span><br><span class="line">是否有mysql-bin.000001 和 mysql-bin.index </span><br><span class="line">5. SQLYog中(或mysql中), 查看数据库日志状态: show master status</span><br><span class="line">6. 重复1~5步, 配置从库(id=2即可)</span><br><span class="line"></span><br><span class="line">// 配置主从</span><br><span class="line">1. 只需在从库中配置如下</span><br><span class="line">change master to master_host=&quot;192.168.112.132&quot;,</span><br><span class="line">master_port=3306,</span><br><span class="line">master_user=&quot;root&quot;,</span><br><span class="line">master_password=&quot;root&quot;,</span><br><span class="line">master_log_file=&quot;mysql-bin.000001&quot;,</span><br><span class="line">master_log_pos=120</span><br><span class="line">2. 注意上述master_log_file/master_log_pos 为主库的二进制文件状态</span><br><span class="line">3. 开启主从服务: start slave </span><br><span class="line">4. 检查主从状态: show slave status </span><br><span class="line">5. 测试主从: 修改主库信息(注意, 不能修改从库信息)</span><br><span class="line"></span><br><span class="line">//注意防火墙问题, 二进制文件会随着更新操作依次累加, 注意配置是否正确.</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ul>
<li>Amoeba 数据库代理</li>
</ul>
<ol>
<li>数据库代理: 以mysql为底层数据存储, 集中处理应用的请求, 实现负载均衡, 读写分离, 高可用等要求. </li>
<li>Amoeba 搭建: <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">1. java -version</span><br><span class="line">2. 上传Amoeba</span><br><span class="line">3. tar -xvf amoeba-mysql-3.0.4.tar.gz</span><br><span class="line">4. cd amoeba-mysql-3.0.4</span><br><span class="line">5. 修改配置 dbServers.xml</span><br><span class="line">添加用户名/密码</span><br><span class="line">&lt;property name=&quot;user&quot;&gt;root&lt;/property&gt;</span><br><span class="line">&lt;property name=&quot;password&quot;&gt;root&lt;/property&gt;</span><br><span class="line">指定主机服务</span><br><span class="line">&lt;dbServer name=&quot;master&quot; parent=&quot;abstractServer&quot;&gt;</span><br><span class="line">&lt;factoryConfig&gt;</span><br><span class="line">  &lt;property name=&quot;ipAddress&quot;&gt;192.168.112.132&lt;/property&gt;</span><br><span class="line">&lt;/factoryConfig&gt;</span><br><span class="line">&lt;/dbServer&gt;</span><br><span class="line">指定从机服务</span><br><span class="line">&lt;dbServer name=&quot;slave01&quot; parent=&quot;abstractServer&quot;&gt;</span><br><span class="line">&lt;factoryConfig&gt;</span><br><span class="line">  &lt;property name=&quot;ipAddress&quot;&gt;192.168.112.132&lt;/property&gt;</span><br><span class="line">&lt;/factoryConfig&gt;</span><br><span class="line">&lt;/dbServer&gt;</span><br><span class="line">&lt;dbServer name=&quot;slave02&quot; parent=&quot;abstractServer&quot;&gt;</span><br><span class="line">&lt;factoryConfig&gt;</span><br><span class="line">  &lt;property name=&quot;ipAddress&quot;&gt;192.168.112.132&lt;/property&gt;</span><br><span class="line">&lt;/factoryConfig&gt;</span><br><span class="line">&lt;/dbServer&gt;</span><br><span class="line">配置读取连接池</span><br><span class="line">&lt;dbServer name=&quot;multiPool&quot; virtual=&quot;true&quot;&gt;</span><br><span class="line">&lt;poolConfig class=&quot;com.meidusa.amoeab.server.MultipleServerPool&quot;&gt;</span><br><span class="line">  &lt;property name=&quot;loadbalance&quot;&gt;1&lt;/property&gt;</span><br><span class="line">  &lt;property name=&quot;poolNames&quot;&gt;slave01,master,slave01&lt;/property&gt;</span><br><span class="line">&lt;/poolConfig&gt;</span><br><span class="line">&lt;/dbServer&gt;</span><br><span class="line">6. 配置amoeba.xml </span><br><span class="line">修改登陆用户名密码</span><br><span class="line">&lt;property name=&quot;user&quot;&gt;root&lt;/property&gt;</span><br><span class="line">&lt;property name=&quot;password&quot;&gt;root&lt;/property&gt;</span><br><span class="line">实现读写分离</span><br><span class="line">&lt;property name=&quot;defaultPool&quot;&gt;master&lt;/property&gt;</span><br><span class="line">&lt;property name=&quot;writerPool&quot;&gt;master&lt;/property&gt;</span><br><span class="line">&lt;property name=&quot;readPool&quot;&gt;multiPool&lt;/property&gt;</span><br><span class="line">7. 修改jvm 内存</span><br><span class="line">JVM_OPTIONS=&quot;-server -Xms512m -Xmx1024m -Xss256k -XX:PermSize=16m -XX:MaxPermSize=96m&quot;</span><br><span class="line">8. 启动Amoeba</span><br><span class="line">service iptables stop</span><br><span class="line">cd amoeba-mysql-3.0.4/bin</span><br><span class="line">./launcher </span><br><span class="line">9. 测试连接SQLyog, 查看主从数据库信息</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ul>
<li>双机热备模式</li>
</ul>
<ol>
<li>问题: 实现数据库主从复制后, 主库宕机后, 整个服务将会停止.  </li>
<li>问题2: 此时, 数据同步性问题出现. 主库宕机, 从机继续进行读写操作. 主库成功重启后, 数据库信息不同步如何处理?</li>
<li>解决: 双机热备用.</li>
<li>双机热备用: 实现数据库高可用, 当主机宕机, mycat代理服务器实现高可用自动切换到从机. 提供用户的读写操作, 将更新操作写入二进制日志文件中, 主机重启后自动同步二进制日志信息, 同步更新数据, 完成同步.</li>
</ol>
<ul>
<li>Mycat部署</li>
</ul>
<ol>
<li><p>java -version </p>
</li>
<li><p>上传mycat-server-1.7.0-xxx.tar.gz</p>
</li>
<li><p>tar -xvf mycat-server-1.7.0-xxx.tar.gz</p>
</li>
<li><p>配置Server.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;user name=&quot;root&quot;&gt;</span><br><span class="line">  &lt;property name=&quot;password&quot;&gt;root&lt;/property&gt;</span><br><span class="line">  &lt;property name=&quot;schemas&quot;&gt;jtdb&lt;/property&gt;</span><br><span class="line">&lt;/user&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置schmea.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--name属性是自定义的  dataNode表示数据库的节点信息--&gt;</span><br><span class="line">&lt;schema name=&quot;jtdb&quot; checkSQLschema=&quot;false&quot; sqlMaxLimit=&quot;100&quot; dataNode=&quot;jtdb&quot;&gt;&lt;/schema&gt;</span><br><span class="line"></span><br><span class="line">&lt;!--定义节点名称/节点主机/数据名称--&gt;</span><br><span class="line">&lt;dataNode name=&quot;jtdb&quot; dataHost=&quot;localhost1&quot; database=&quot;jtdb&quot; /&gt;</span><br><span class="line">	&lt;!--参数介绍--&gt;</span><br><span class="line">	&lt;!--balance 0表示所有的读操作都会发往writeHost主机 --&gt;  </span><br><span class="line">	&lt;!--1表示所有的读操作发往readHost和闲置的主节点中--&gt;</span><br><span class="line">	&lt;!--writeType=0 所有的写操作都发往第一个writeHost主机--&gt;	</span><br><span class="line">	&lt;!--writeType=1 所有的写操作随机发往writeHost中--&gt;</span><br><span class="line">	&lt;!--dbType 表示数据库类型 mysql/oracle--&gt;</span><br><span class="line">	&lt;!--dbDriver=&quot;native&quot;  固定参数 不变--&gt;</span><br><span class="line">	&lt;!--switchType=-1 表示不自动切换, 主机宕机后不会自动切换从节点--&gt;</span><br><span class="line">	&lt;!--switchType=1  表示会自动切换(默认值)如果第一个主节点宕机后,Mycat会进行3次心跳检测,如果3次都没有响应,则会自动切换到第二个主节点--&gt;</span><br><span class="line">	&lt;!--并且会更新/conf/dnindex.properties文件的主节点信息 localhost1=0 表示第一个节点.该文件不要随意修改否则会出现大问题--&gt;</span><br><span class="line">&lt;dataHost name=&quot;localhost1&quot; maxCon=&quot;1000&quot; minCon=&quot;10&quot; balance=&quot;1&quot;</span><br><span class="line">		  writeType=&quot;0&quot; dbType=&quot;mysql&quot; dbDriver=&quot;native&quot; switchType=&quot;1&quot;  slaveThreshold=&quot;100&quot;&gt;</span><br><span class="line">	&lt;heartbeat&gt;select 1&lt;/heartbeat&gt;</span><br><span class="line"></span><br><span class="line">	&lt;!--配置第一台主机主要进行写库操作,在默认的条件下Mycat主要操作第一台主机在第一台主机中已经实现了读写分离.因为默认写操作会发往137的数据库.读的操作默认发往141.如果从节点比较忙,则主节点分担部分压力.</span><br><span class="line">	--&gt;</span><br><span class="line">	&lt;writeHost host=&quot;hostM1&quot; url=&quot;192.168.126.137:3306&quot; user=&quot;root&quot; password=&quot;root&quot;&gt;</span><br><span class="line">		&lt;!--读数据库--&gt;</span><br><span class="line">		&lt;readHost host=&quot;hostS1&quot; url=&quot;192.168.126.141:3306&quot; user=&quot;root&quot; password=&quot;root&quot; /&gt;</span><br><span class="line">	&lt;/writeHost&gt;</span><br><span class="line"></span><br><span class="line">		&lt;!--定义第二台主机 由于数据库内部已经实现了双机热备.--&gt;</span><br><span class="line">		&lt;!--Mycat实现高可用.当第一个主机137宕机后.mycat会自动发出心跳检测.检测3次.--&gt;</span><br><span class="line">		&lt;!--如果主机137没有给Mycat响应则判断主机死亡.则回启东第二台主机继续为用户提供服务.--&gt;</span><br><span class="line">		&lt;!--如果137主机恢复之后则处于等待状态.如果141宕机则137再次持续为用户提供服务.--&gt;</span><br><span class="line">		&lt;!--前提:实现双机热备.--&gt;</span><br><span class="line">	</span><br><span class="line">	&lt;writeHost host=&quot;hostM2&quot; url=&quot;192.168.126.141:3306&quot; user=&quot;root&quot; password=&quot;root&quot;&gt;</span><br><span class="line">		&lt;readHost host=&quot;hostS1&quot; url=&quot;192.168.126.137:3306&quot; user=&quot;root&quot; password=&quot;root&quot; /&gt;</span><br><span class="line">	&lt;/writeHost&gt;</span><br><span class="line">&lt;/dataHost&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动mycat:<br>./mycat start<br>./mycat stop</p>
</li>
<li><p>测试mycat:<br>关闭主库mysql, 从库更新数据, 重启主库, 查看数据是否同步.</p>
</li>
</ol>
</div></article></div></main><footer><div class="paginator"><a href="/tinytinycn.github.io/2018/02/20/06-project-Redis-Basic/" class="prev">PREV</a><a href="/tinytinycn.github.io/2018/02/17/04-project-Linux下软件安装与配置/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2019 <a href="http://github.com">hang</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>