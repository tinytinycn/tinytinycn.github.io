<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 03_project_Nginx配置文件 · hang 's blogs</title><meta name="description" content="03_project_Nginx配置文件 - hang"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/tinytinycn.github.io/favicon.png"><link rel="stylesheet" href="/tinytinycn.github.io/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://github.com/atom.xml" title="hang 's blogs"></head><body><div class="wrap"><header><a href="/tinytinycn.github.io/" class="logo-link"><img src="/tinytinycn.github.io/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/tinytinycn.github.io/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/tinytinycn.github.io/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/sunchongsheng" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pinggod" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/tinytinycn.github.io/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">03_project_Nginx配置文件</h1><div class="post-info">Feb 15, 2018</div><div class="post-content"><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li>nginx配置</li>
<li>main模块</li>
<li>events模块</li>
<li>http模块</li>
<li>server模块</li>
<li>location模块</li>
<li>upstream模块</li>
</ul>
<p>–</p>
<h2 id="nginx配置"><a href="#nginx配置" class="headerlink" title="nginx配置"></a>nginx配置</h2><p>项目中使用最多的三个核心功能: 反向代理/负载均衡/静态服务器;<br>有关配置主要集中在nginx.conf配置文件中:</p>
<ul>
<li>main:   全局配置.(用户组|pid|日志|配置引入|worker_process)</li>
<li>events: 工作模式配置(连接数|事件驱动模式|连接请求)</li>
<li>http:   http协议配置(server|location|upstream|)</li>
<li>server: 代理服务器访问配置(虚拟主机参数配置)</li>
<li>location:路由配置(页面处理请求)</li>
<li>upstream:负载均衡配置</li>
</ul>
<h2 id="main模块"><a href="#main模块" class="headerlink" title="main模块:"></a>main模块:</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># user nobody nobody;</span><br><span class="line">worker_processes 2;</span><br><span class="line"># error_log logs/error.log</span><br><span class="line"># error_log logs/error.log notice</span><br><span class="line"># error_log logs/error.log info</span><br><span class="line"># pid logs/nginx.pid</span><br><span class="line">worker_rlimit_nofile 1024;</span><br><span class="line"></span><br><span class="line"># user              指定nginx worker进程运行用户及用户组</span><br><span class="line"># worker_processes  指定nginx 开启子进程数量(运行过程中监控每个进程消耗内存(一般几M~几十M不等)根据实际情况进行调整，通常数量是CPU内核数量的整数倍)</span><br><span class="line"># error_log         指定错误日志存放位置及输出级别(debug|info|notice|warn|error|crit)</span><br><span class="line"># pid               指定进程id的存放位置</span><br><span class="line"># worker_rlimit_nofile 指定一个进程可以打开最多文件数量的描述</span><br></pre></td></tr></table></figure>

<h2 id="event模块"><a href="#event模块" class="headerlink" title="event模块:"></a>event模块:</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">event &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">    multi_accept on;</span><br><span class="line">    use epoll;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># worker_connections  指定最大可以同时接收的连接数量(注意: 最大连接数量和worker_processes共同决定, 理论上每台nginx服务器的最大连接数为。worker_processes * worker_connections)</span><br><span class="line"># multi_accept        指定nginx在收到一个新连接通知后, 尽可能多的接收更多连接</span><br><span class="line"># use epoll           指定线程轮询(linux2.6+:epoll/BSD:Kqueue)</span><br></pre></td></tr></table></figure>

<h2 id="http模块"><a href="#http模块" class="headerlink" title="http模块:"></a>http模块:</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    ##</span><br><span class="line">    # 基础配置</span><br><span class="line">    # sendfile on: 将文件的回写过程交给数据缓存区完成,而不是放在应用中完成,有利于提升性能</span><br><span class="line">    # tcp_nopush on: 让nginx在一个数据包中发送所有的头文件,而不是一个个单独发送</span><br><span class="line">    # tcp_nodelay on: 让nginx不要缓存数据,而是一段段发送. 如果数据的传输有实时性要求可以配置它,发送完一段数据就立刻得到返回值.</span><br><span class="line">    # keepalive_timeout 10: 给客户端分配连接超时时间,服务器在这个时间之后关闭连接. 一般设置时间较短,nginx工作持续性更好</span><br><span class="line">    # client_header_timeout 10: 设置请求头超时时间</span><br><span class="line">    # client_body_timeout 10: 设置请求实体超时时间</span><br><span class="line">    # client_header_buffer_size 4K: 客户端请求头部的缓冲区大小。这个可以根据你的系统分页大小来设置，一般一个请求头的大小不会超过1k，不过由于一般系统分页都要大于1k，所以这里设置为分页大小.</span><br><span class="line">    # send_timeout 10: 设置客户端响应超时时间, 客户端两次操作间隔超过这个时间, 服务器关闭连接</span><br><span class="line">    # limit_conn_zone $binary_remote_addr zone=addr:5m 设置用于保存各种key的共享内存参数</span><br><span class="line">    # limit_conn addr 100: 给定的key设置最大连接数</span><br><span class="line">    # server_tokens: 错误页面关闭nginx版本提示, 提升网站安全性</span><br><span class="line">    # include /etc/nginx/mime.types: 指定在当前文件中包含另一个文件的指令</span><br><span class="line">    # default_type application/octet-stream: 指定more处理的文件类型可以是二进制</span><br><span class="line">    # type_hash_max_size 2048: 混淆数据, 影响三列冲突率, 值越大消耗内存越多, 散列key冲突率会降低, 检索速度更快; </span><br><span class="line">    ##</span><br><span class="line"></span><br><span class="line">    sendfile on;</span><br><span class="line">    tcp_nopush on;</span><br><span class="line">    tcp_nodelay on;</span><br><span class="line">    keepalive_timeout 65;</span><br><span class="line">    types_hash_max_size 2048;</span><br><span class="line">    # server_tokens off;</span><br><span class="line"></span><br><span class="line">    # server_names_hash_bucket_size 64;</span><br><span class="line">    # server_name_in_redirect off;</span><br><span class="line"></span><br><span class="line">    include /etc/nginx/mime.types;</span><br><span class="line">    default_type application/octet-stream;</span><br><span class="line"></span><br><span class="line">    ##</span><br><span class="line">    # SSL证书配置</span><br><span class="line">    # ssl_protocols: 开启特定加密协议(nginx在1.1.13和1.0.12版本后默认是ssl_protocols SSLv3 TLSv1 TLSv1.1 TLSv1.2，TLSv1.1与TLSv1.2要确保OpenSSL &gt;= 1.0.1 ，SSLv3 现在还有很多地方在用但有不少被攻击的漏洞)</span><br><span class="line">    # ssl_prefer_server_ciphers on:设置协商加密算法, 优先使用服务端的加密套件,而不是客户端的加密套件</span><br><span class="line">    ##</span><br><span class="line"></span><br><span class="line">    ssl_protocols TLSv1 TLSv1.1 TLSv1.2; # Dropping SSLv3, ref: POODLE</span><br><span class="line">    ssl_prefer_server_ciphers on;</span><br><span class="line"></span><br><span class="line">    ##</span><br><span class="line">    # 日志配置</span><br><span class="line">    # access_log logs/access.log: 设置存储访问记录的日志</span><br><span class="line">    # error_log logs/error.log: 设置存储错误记录的日志</span><br><span class="line">    ##</span><br><span class="line"></span><br><span class="line">    access_log /var/log/nginx/access.log;</span><br><span class="line">    error_log /var/log/nginx/error.log;</span><br><span class="line"></span><br><span class="line">    ##</span><br><span class="line">    # Gzip 压缩配置</span><br><span class="line">    # gzip on: 采用gzip压缩形式发送数据.减少发送的数据量</span><br><span class="line">    # gzip_disable: 指定客户端禁用gzip功能.(设置成IE6或者更低版本以使我们的方案能够广泛兼容)</span><br><span class="line">    # gzip_proxied: 允许或禁止压缩基于请求和响应的响应流.(设置成any,意味着见鬼压缩所有的请求)</span><br><span class="line">    # gzip_min_length: 设置对数据启用压缩的最小字节数.(如果一个请求小于1000字节，我们最好不要压缩它，因为压缩这些小的数据会降低处理此请求的所有进程的速度.)</span><br><span class="line">    # gizp_comp_level: 设置数据的压缩等级.等级可以1-9之间任意数值.(9是最慢但是压缩比最大的。我们设置为4，这是一个比较折中的设置.)</span><br><span class="line">    # gzip_type: 设置需要压缩的数据格式.</span><br><span class="line">    ##</span><br><span class="line"></span><br><span class="line">    gzip on;</span><br><span class="line">    gzip_disable &quot;msie6&quot;;</span><br><span class="line"></span><br><span class="line">    # gzip_vary on;</span><br><span class="line">    # gzip_proxied any;</span><br><span class="line">    # gzip_comp_level 6;</span><br><span class="line">    # gzip_buffers 16 8k;</span><br><span class="line">    # gzip_http_version 1.1;</span><br><span class="line">    # gzip_types text/plain text/css application/json application/javascript</span><br><span class="line"> text/xml application/xml application/xml+rss text/javascript;</span><br><span class="line"></span><br><span class="line">    ##</span><br><span class="line">    # 文件缓存配置</span><br><span class="line">    # open_file_cache: 打开缓存的同时也指定了缓存最大数目，以及缓存的时间。我们可以设置一个相对高的最大时间，这样我们可以在它们不活动超过20秒后清除掉。</span><br><span class="line">    # open_file_cache_valid: 在open_file_cache中指定检测正确信息的间隔时间。</span><br><span class="line">    # open_file_cache_min_uses: 定义了open_file_cache中指令参数不活动时间期间里最小的文件数。</span><br><span class="line">    # open_file_cache_errors: 指定了当搜索一个文件时是否缓存错误信息，也包括再次给配置中添加文件。我们也包括了服务器模块，这些是在不同文件中定义的。如果你的服务器模块不在这些位置，你就得修改这一行来指定正确的位置。</span><br><span class="line">    ##</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ##</span><br><span class="line">    # 虚拟主机配置</span><br><span class="line">    ##</span><br><span class="line"></span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line">    include /etc/nginx/sites-enabled/*;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="server模块-http模块的子模块"><a href="#server模块-http模块的子模块" class="headerlink" title="server模块:(http模块的子模块)"></a>server模块:(http模块的子模块)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen        80;</span><br><span class="line">    server_name localhost    192.168.1.100;</span><br><span class="line">    root        /nginx/www;</span><br><span class="line">    index        index.php index.html index.html;</span><br><span class="line">    charset        utf-8;</span><br><span class="line">    access_log    logs/access.log;</span><br><span class="line">    error_log    logs/error.log;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    # server: 一个虚拟主机的配置, 一个http模块中可以配置多个server</span><br><span class="line">    # listen: 监听端口</span><br><span class="line">    # server_name: 指定ip地址或域名, 多个配置之间用空格分隔</span><br><span class="line">    # root: 表示整个server虚拟主机内的根目录, 所有当前主机中web项目的根目录</span><br><span class="line">    # index: 用户访问web网站的全局首页</span><br><span class="line">    # charset: 设置www/路径中配置的页面的默认编码格式</span><br><span class="line">    # access_log: 指定虚拟主机服务器中访问记录日志存放路径</span><br><span class="line">    # error_log:  指定虚拟主机服务器中访问错误日志存放路径</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="location模块"><a href="#location模块" class="headerlink" title="location模块"></a>location模块</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    root    /nginx/www;</span><br><span class="line">    index    index.php index.html index.htm;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    # location: 主要用于配置路由访问信息</span><br><span class="line">    # location /: 表示匹配访问根目录</span><br><span class="line">    # location ~* \.(mp3|exe)$ 对以“mp3或exe”结尾的地址进行负载均衡</span><br><span class="line">    # root: 指定访问根目录时, 访问虚拟主机的web目录</span><br><span class="line">    # index: 在不指定范文具体资源时, 默认展示的资源文件列表</span><br><span class="line"></span><br><span class="line">1)反向代理配置方式: 通过proxy_set配置让客户端访问透明化</span><br><span class="line">location / &#123;</span><br><span class="line">    proxy_pass http://localhost:8888;</span><br><span class="line">    proxy_set_header X-real-ip $remote_addr;</span><br><span class="line">    proxy_set_header Host $http_host;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">    proxy_pass http://local:8888;</span><br><span class="line">    proxy_set_header Host $host;</span><br><span class="line">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    # 目的是将代理服务器收到的用户的信息传到真实服务器上</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">2)uwsgi配置方式: </span><br><span class="line">location / &#123;</span><br><span class="line">    include uwsgi_params;</span><br><span class="line">    uwsgi_pass localhost:8888</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="upstream模块"><a href="#upstream模块" class="headerlink" title="upstream模块:"></a>upstream模块:</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">upstream name &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    server 192.168.1.100:8000;</span><br><span class="line">    server 192.168.1.100:8001 down;</span><br><span class="line">    server 192.168.1.100:8002 max_fails=3;</span><br><span class="line">    server 192.168.1.100:8003 fail_timeout=20s;</span><br><span class="line">    server 192.168.1.100:8004 max_fails=3 fail_timeout=20s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    # upstream: 主要负责负载均衡, 默认通过轮询调度方式分发请求到后端服务器</span><br><span class="line">    # ip_hash: 指定请求调度算法.(默认weight权重轮询调度,可指定)</span><br><span class="line">    # server host:port: 指定分发服务器的列表配置</span><br><span class="line">    # --down: 表示主机暂停服务</span><br><span class="line">    # --max_fails: 表示失败最大次数, 超过失败最大次数暂停服务</span><br><span class="line">    # --fail_timeout: 表示请求失败, 暂停指定的时间后重新发起请求</span><br></pre></td></tr></table></figure>

<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><p>Ngx_http_core_module模块支持内置变量，他们的名字和apache的内置变量是一致的。</p>
<p>首先是说明客户请求title中的行，例如$http_user_agent,$http_cookie等等。</p>
<p>此外还有其它的一些变量: </p>
<p>$args此变量与请求行中的参数相等<br>$content_length等于请求行的“Content_Length”的值。<br>$content_type等同与请求头部的”Content_Type”的值<br>$document_root等同于当前请求的root指令指定的值<br>$document_uri与$uri一样<br>$host与请求头部中“Host”行指定的值或是request到达的server的名字（没有Host行）一样<br>$limit_rate允许限制的连接速率<br>$request_method等同于request的method，通常是“GET”或“POST”<br>$remote_addr客户端ip<br>$remote_port客户端port<br>$remote_user等同于用户名，由ngx_http_auth_basic_module认证<br>$request_filename当前请求的文件的路径名，由root或alias和URI request组合而成<br>$request_body_file<br>$request_uri含有参数的完整的初始URI<br>$query_string与$args一样<br>$sheeme http模式（http,https）尽在要求是评估例如<br>Rewrite ^(.+)$ $sheme://example.com$; Redirect;<br>$server_protocol等同于request的协议，使用“HTTP/或“HTTP/<br>$server_addr request到达的server的ip，一般获得此变量的值的目的是进行系统调用。为了避免系统调用，有必要在listen指令中指明ip，并使用bind参数。<br>$server_name请求到达的服务器名<br>$server_port请求到达的服务器的端口号<br>$uri等同于当前request中的URI，可不同于初始值，例如内部重定向时或使用index</p>
</div></article></div></main><footer><div class="paginator"><a href="/tinytinycn.github.io/2018/02/17/04-project-Linux下软件安装与配置/" class="prev">PREV</a><a href="/tinytinycn.github.io/2018/02/14/02-project-Nginx/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2019 <a href="http://github.com">hang</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>