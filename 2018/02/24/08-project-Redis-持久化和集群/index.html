<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 08_project_Redis_持久化和集群 · hang 's blogs</title><meta name="description" content="08_project_Redis_持久化和集群 - hang"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/tinytinycn.github.io/favicon.png"><link rel="stylesheet" href="/tinytinycn.github.io/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://github.com/atom.xml" title="hang 's blogs"></head><body><div class="wrap"><header><a href="/tinytinycn.github.io/" class="logo-link"><img src="/tinytinycn.github.io/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/tinytinycn.github.io/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/tinytinycn.github.io/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/sunchongsheng" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pinggod" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/tinytinycn.github.io/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">08_project_Redis_持久化和集群</h1><div class="post-info">Feb 24, 2018</div><div class="post-content"><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li>Redis持久化</li>
<li>Redis集群</li>
</ul>
<hr>
<ul>
<li>Redis持久化</li>
</ul>
<ol>
<li><p>RDB模式<br>RDB, redis默认持久化方式. Redis默认每15分钟持久化一次, 将redis中内存数据写到.rdb磁盘文件中. 当redis节点宕机后, redis重启将从rdb文件中读取持久化数据, 恢复内存数据.</p>
</li>
<li><p>持久化策略</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#根据自身需要进行调整持久化策略</span><br><span class="line">#如果redis在900s(15分钟)/300s/60s执行了一次set操作, 则进行save 持久化操作1/10/10000次</span><br><span class="line">save 900 1</span><br><span class="line">save 300 10 </span><br><span class="line">save 60 10000</span><br></pre></td></tr></table></figure>
</li>
<li><p>手动持久化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">在客户端手动输入指令: save或bgsave</span><br><span class="line">执行save指令时, 首先会开启一个线程, 主动执行持久化操作. 此时所有redis操作会阻塞, 直到持久化操作完成;</span><br><span class="line">执行bgsave指令时, 则不会造成阻塞现象. 但是会开启一个后台线程, 不能保证持久化操作立即执行.</span><br></pre></td></tr></table></figure>
</li>
<li><p>持久化文件和路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dbfilename &quot;dump.rdb&quot;</span><br><span class="line">dir &quot;/usr/local/src/redis-3.2.8/sentinel&quot;</span><br><span class="line">//注意: </span><br><span class="line">//redis服务器关机后, 重启分片的每台redis数据都相同, 可能是因为持久化文件和路径相同导致的.</span><br><span class="line">//一般这里的配置, 尽量保持不同路径.</span><br></pre></td></tr></table></figure>
</li>
<li><p>AOF模式<br>AOF, 能够满足实时持久化的要求, 但是消耗较大的性能. 默认aof策略关闭. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#开启AOF</span><br><span class="line">appendonly yes (取消注释即可)</span><br><span class="line">//aof持久化策略开启后, rdb将不作用.</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>AOF持久化策略</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#appendsync always 实施备份, redis性能较低</span><br><span class="line">appendsync everysec 每秒持久化一次, redis效率略低于rdb</span><br><span class="line">#appendsync no 持久化时间交由系统决定, 不确定性强</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>redis内存策略<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#redis中可以手动设置最大内存, 当内存达到存满现象时, redis会根据内存策略进行维护.</span><br><span class="line">#设置最大内存</span><br><span class="line">#maxmemory &lt;bytes&gt;</span><br><span class="line">#volatile-lru   从已经设置过期时间的数据中, 选择最少使用的删除</span><br><span class="line">#allkeys-lru    从全部数据中, 选择最少使用的删除</span><br><span class="line">#volatile-random 从已经设置过期时间的数据中, 随机删除</span><br><span class="line">#allkeys-ttl     从已经设置过期时间的数据中, 选择立马过期的数据进行释放操作</span><br><span class="line">#noeviction     默认redis内存策略. 不会删除数据, 进行redis读写操作时, 直接报错</span><br><span class="line"></span><br><span class="line">maxmemory-samples 1-10 设置10可靠性更好,但性能最低, 3速度快,但效果不理想, 默认5</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ul>
<li>Redis集群</li>
</ul>
<ol>
<li>集群的优点:<br>a. 集群可实现内部的高可用;<br>b. 集群可通过多台主机共享内存;<br>c. 集群部署无需手动挂载, 程序自动维护;<br>d. 一般采用: 一主两从, 3主互指, 共9台服务器;</li>
<li>集群搭建<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">1.mkdir /cluster/7000 ... /7008 创建多个目录 </span><br><span class="line">2. cp redis.conf /cluster/redis-7000.conf</span><br><span class="line">cp redis.conf /cluster/redis-7001.conf</span><br><span class="line">cp redis.conf /cluster/redis-7002.conf</span><br><span class="line">cp redis.conf /cluster/redis-7003.conf</span><br><span class="line">cp redis.conf /cluster/redis-7004.conf</span><br><span class="line">cp redis.conf /cluster/redis-7005.conf</span><br><span class="line">cp redis.conf /cluster/redis-7006.conf</span><br><span class="line">cp redis.conf /cluster/redis-7007.conf</span><br><span class="line">cp redis.conf /cluster/redis-7008.conf</span><br><span class="line">3. 修改配置 </span><br><span class="line">#bind 127.0.0.1   注释ip绑定</span><br><span class="line">protected-mode no 取消注释,关闭保护模式</span><br><span class="line">port 7000         修改端口7000-7008</span><br><span class="line">daemonize yes     开启后台启动</span><br><span class="line">pidfile /usr/local/src/redis-3.2.8/cluster/7000/redis_7000.pid 修改pid路径</span><br><span class="line">dbfilename dump-7000.rdb 修改持久化文件</span><br><span class="line">dir &quot;/user/local/src/redis-3.2.8/cluster/7000&quot; 修改持久化路径</span><br><span class="line">maxmemory-policy allkeys-lru 修改内存策略</span><br><span class="line">cluster-enabled yes          开启集群应用</span><br><span class="line">cluster-config-file nodes-7000.conf 修改集群节点信息</span><br><span class="line">4. 批量启动redis节点脚本</span><br><span class="line">#!/bin/sh</span><br><span class="line">redis-server 7000/redis-7000.conf &amp; </span><br><span class="line">redis-server 7001/redis-7001.conf &amp; </span><br><span class="line">redis-server 7002/redis-7002.conf &amp; </span><br><span class="line">redis-server 7003/redis-7003.conf &amp; </span><br><span class="line">redis-server 7004/redis-7004.conf &amp; </span><br><span class="line">redis-server 7005/redis-7005.conf &amp; </span><br><span class="line">redis-server 7006/redis-7006.conf &amp; </span><br><span class="line">redis-server 7007/redis-7007.conf &amp; </span><br><span class="line">redis-server 7008/redis-7008.conf &amp; </span><br><span class="line">5. 关闭防火墙</span><br><span class="line">sevice iptables stop </span><br><span class="line">6. 集群启动需要依赖的插件 ruby </span><br><span class="line">启动指令: </span><br><span class="line">./src/redis-trib.rb create --replicas 2 192.168.112.132:7000 192.168.112.132:7001 192.168.112.132:7002 192.168.112.132:7003 192.168.112.132:7004 192.168.112.132:7005 192.168.112.132:7006 192.168.112.132:7007 192.168.112.132:7008</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ul>
<li>Redis集群到Spring</li>
</ul>
<ol>
<li><p>applicationContext-redis.xml配置 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- jedis 配置--&gt;  </span><br><span class="line">&lt;bean id=&quot;poolConfig&quot; class=&quot;redis.clients.jedis.JedisPoolConfig&quot; &gt;  </span><br><span class="line">     &lt;!--最大空闲数--&gt;  </span><br><span class="line">     &lt;property name=&quot;maxIdle&quot; value=&quot;$&#123;redis.maxIdle&#125;&quot; /&gt;  </span><br><span class="line">     &lt;!--最大建立连接等待时间--&gt;  </span><br><span class="line">     &lt;property name=&quot;maxWaitMillis&quot; value=&quot;$&#123;redis.maxWait&#125;&quot; /&gt;  </span><br><span class="line">     &lt;!--是否在从池中取出连接前进行检验,如果检验失败,则从池中去除连接并尝试取出另一个--&gt;  </span><br><span class="line">     &lt;property name=&quot;testOnBorrow&quot; value=&quot;$&#123;redis.testOnBorrow&#125;&quot; /&gt;  </span><br><span class="line">     &lt;property name=&quot;maxTotal&quot; value=&quot;$&#123;redis.maxTotal&#125;&quot; /&gt;  </span><br><span class="line">     &lt;property name=&quot;minIdle&quot; value=&quot;$&#123;redis.minIdle&#125;&quot; /&gt;  </span><br><span class="line">&lt;/bean&gt;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">&lt;bean id=&quot;jedisCluster&quot;  class=&quot;cn.tinytiny.common.util.RedisCluster&quot; &gt;  </span><br><span class="line">     &lt;property name=&quot;addressConfig&quot;&gt;</span><br><span class="line">         &lt;value&gt;classpath:/properties/redis.properties&lt;/value&gt;  </span><br><span class="line">     &lt;/property&gt;  </span><br><span class="line">     &lt;property name=&quot;addressKeyPrefix&quot; value=&quot;redis.cluster&quot; /&gt; </span><br><span class="line">     &lt;!--  属性文件里  key的前缀 --&gt;  </span><br><span class="line">     &lt;property name=&quot;timeout&quot; value=&quot;$&#123;redis.timeout&#125;&quot; /&gt;  </span><br><span class="line">     &lt;property name=&quot;maxRedirections&quot; value=&quot;6&quot; /&gt;  </span><br><span class="line">     &lt;property name=&quot;genericObjectPoolConfig&quot; ref=&quot;poolConfig&quot; /&gt;  </span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>redis.properties配置 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">redis.minIdle=100</span><br><span class="line">redis.maxIdle=300 </span><br><span class="line">redis.maxTotal=1000 </span><br><span class="line">redis.timeout=5000 </span><br><span class="line">redis.maxWait=1000 </span><br><span class="line">redis.testOnBorrow=true </span><br><span class="line">redis.cluster0.host.port=192.169.112.132:7000</span><br><span class="line">redis.cluster0.host.port=192.169.112.132:7001</span><br><span class="line">redis.cluster0.host.port=192.169.112.132:7002</span><br><span class="line">redis.cluster0.host.port=192.169.112.132:7003</span><br><span class="line">redis.cluster0.host.port=192.169.112.132:7004</span><br><span class="line">redis.cluster0.host.port=192.169.112.132:7005</span><br><span class="line">redis.cluster0.host.port=192.169.112.132:7006</span><br><span class="line">redis.cluster0.host.port=192.169.112.132:7007</span><br><span class="line">redis.cluster0.host.port=192.169.112.132:7008</span><br></pre></td></tr></table></figure>
</li>
<li><p>工具类RedisCluster </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public class RedisCluster implements FactoryBean&lt;JedisCluster&gt;,InitializingBean&#123;</span><br><span class="line">  //创建对象</span><br><span class="line">  public void aferPorpertiesSet() throws Exception&#123;</span><br><span class="line">    Set&lt;HostAndPort&gt; haps = this.parseHostAndPort();</span><br><span class="line">    jedisCluster = new JedisCluster(haps, timeout, maxRedirections);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  //通过工厂创建对象</span><br><span class="line">  public JedisCluster getObject() throws Exception&#123;</span><br><span class="line">    return jedisCluster; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>业务层</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@Autowired</span><br><span class="line">private JedisCluster jedisCluster;</span><br></pre></td></tr></table></figure>
</li>
<li><p>RedisService类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Service </span><br><span class="line">public class RedisService&#123;</span><br><span class="line">   @Autowired</span><br><span class="line">   private JedisSentinelPool jedisSentinelPool;</span><br><span class="line">   </span><br><span class="line">   public void set(String key, String value)&#123;</span><br><span class="line">      Jedis jedis = jedisSentinelPool.getResource();</span><br><span class="line">      jedis.set(key, value);</span><br><span class="line">      jedisSentinelPool.returnResource(jedis);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
</div></article></div></main><footer><div class="paginator"><a href="/tinytinycn.github.io/2018/02/26/09-project-PowerDesigner/" class="prev">上一篇</a><a href="/tinytinycn.github.io/2018/02/22/07-project-Redis-Sentinal-Shard/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2019 <a href="http://github.com">hang</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>